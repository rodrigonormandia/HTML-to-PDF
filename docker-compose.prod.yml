services:
  redis:
    image: redis:7-alpine
    networks:
      - buscarIDnet
    volumes:
      - redis_data:/data
    command: redis-server --maxmemory 256mb --maxmemory-policy volatile-ttl
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  api:
    image: normandiabuscarid/pdf-gravity-api:latest
    networks:
      - buscarIDnet
    environment:
      - PORT=8000
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.pdfgravity-api.rule=Host(`htmltopdf.buscarid.com`) && PathPrefix(`/api`)
        - traefik.http.routers.pdfgravity-api.entrypoints=websecure
        - traefik.http.routers.pdfgravity-api.tls.certresolver=letsencryptresolver
        - traefik.http.routers.pdfgravity-api.service=pdfgravity-api
        - traefik.http.services.pdfgravity-api.loadbalancer.server.port=8000

  celery-worker:
    image: normandiabuscarid/pdf-gravity-api:latest
    networks:
      - buscarIDnet
    command: celery -A backend.celery_app worker --loglevel=info --concurrency=2
    environment:
      - REDIS_URL=redis://redis:6379/0
    depends_on:
      - redis
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager

  web:
    image: normandiabuscarid/pdf-gravity-web:latest
    networks:
      - buscarIDnet
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      labels:
        - traefik.enable=true
        - traefik.http.routers.pdfgravity-web.rule=Host(`htmltopdf.buscarid.com`)
        - traefik.http.routers.pdfgravity-web.entrypoints=websecure
        - traefik.http.routers.pdfgravity-web.priority=1
        - traefik.http.routers.pdfgravity-web.tls.certresolver=letsencryptresolver
        - traefik.http.routers.pdfgravity-web.service=pdfgravity-web
        - traefik.http.services.pdfgravity-web.loadbalancer.server.port=80

networks:
  buscarIDnet:
    external: true

volumes:
  redis_data:
